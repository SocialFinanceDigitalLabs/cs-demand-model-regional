{% extends "dm_regional_app/base.html" %}
{% load crispy_forms_tags %}

{% block content %}

<!-- Modal -->
<div class="modal fade" id="filteringModal" tabindex="-1" aria-labelledby="filteringModalLabel" aria-hidden="true" 
{% if not show_instructions %}style="display:none;"{% endif %}>
<div class="modal-dialog modal-lg">
    <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="filteringModalLabel">Understanding filtering</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <p>
                Filter the data to see the pattern of children in care over time across dimensions such as:
                <ul>
                    <li>Local Authority</li>
                    <li>Ethnicity</li>
                    <li>Sex</li>
                    <li>Unaccompanied asylum seeker children (UASC)</li>
                </ul>
                You may want to filter to focus in on a certain population or child characteristic. 
                For example, you may have a large UASC population and want to create a separate dashboard and model just for that or focus in on sub-regions.
            </p>
            <p>
                The tool will retain any filters or adjustments you make as you go through the tool. You can always continue to filter or change your view as you progress through the tool.
            </p>
            <form id="modalForm" method="POST">
                {% csrf_token %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="dontShowAgain" name="dont_show_again" {% if not show_instructions %}checked{% endif %}>
                    <label class="form-check-label" for="dontShowAgain">
                        Don't show me this again
                    </label>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="savePreference">Save</button>
        </div>
    </div>
</div>
</div>

<br>
    <h1>Model Base Forecast</h1>
    <br>
    <p>Begin modelling your Base Forecast so you can choose the population you want the model to learn from. You can choose:
    <ul>
        <li>The time period you want the model to reference</li>
        <li>When you want your forecast to start</li>
        <li>The population the forecast will include</li>
    </ul></p>
    <!-- Button to manually show the modal -->
        <button type="button" class="btn btn-primary" id="showModalButton">
            Show Filtering Instructions
        </button>
    <br><br>
    {% if empty_dataframe is True %}
        <div class="alert alert-warning" role="alert">
            <h2>There are no children in the historic dataset that match this filter selection</h2>
        </div>
    {% endif %}
    <div class="alert alert-primary" role="alert">
    {{ form.media }}
    <form method="POST">
        {% csrf_token %}
        {% crispy historic_form %}
    </form>
    </div>
    {{ form.media }}
    <form method="POST">
        {% csrf_token %}
        {% crispy predict_form %}
    </form>

<br>

{% if empty_dataframe is False %}
<div class="alert alert-primary" role="alert">
    {{chart|safe}}
</div>

<div class="d-flex bd-highlight mb-3">
    <div class="ms-auto p-2 bd-highlight"><a class="btn btn-info" href="{% url 'save_scenario' %}">Save scenario</a></div>
</div>

<div class="d-flex bd-highlight mb-3">
    <div class="p-2 bd-highlight"><a class="btn btn-secondary" href="{% url 'historic_data' %}">Back</a></div>
    <div class="ms-auto p-2 bd-highlight"><a class="btn btn-primary" href="{% url 'adjusted' %}">Next</a></div>
  </div>

{% endif %}

    <!-- Custom Script for Modal -->
    <script>
        document.getElementById('savePreference').addEventListener('click', () => {
            const dontShowAgain = document.getElementById('dontShowAgain').checked;

            if (dontShowAgain) {
                // Send a POST request to save the user's preference
                fetch("{% url 'update_modal_preference' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({ show_instructions: false })
                }).then(response => {
                    if (response.ok) {
                        console.log("Preference saved");
                    } else {
                        console.error("Failed to save preference");
                    }
                });
            }

            // Hide the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('filteringModal'));
            modal.hide();
        });

        // Show the modal if show_instructions is true
        if ({{ show_instructions|yesno:"true,false" }}) {
            const modal = new bootstrap.Modal(document.getElementById('filteringModal'));
            modal.show();
        }

        // Show modal when the button is clicked
        document.getElementById('showModalButton').addEventListener('click', () => {
            const modal = new bootstrap.Modal(document.getElementById('filteringModal'));
            modal.show();
        });
    </script>
{% endblock content %}

{% block js %}
<script>
    document.getElementById('savePreference').addEventListener('click', () => {
        const dontShowAgain = document.getElementById('dontShowAgain').checked;

        if (dontShowAgain) {
            // Send a POST request to save the user's preference
            fetch("{% url 'update_modal_preference' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ hide_modal: true })
            }).then(response => {
                if (response.ok) {
                    console.log("Preference saved");
                } else {
                    console.error("Failed to save preference");
                }
            });
        }

        // Hide the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('filteringModal'));
        modal.hide();
    });

    // Show the modal if hide_modal is false
    if (!{{ hide_modal|lower }}) {
        const modal = new bootstrap.Modal(document.getElementById('filteringModal'));
        modal.show();
    }
</script>
{% endblock js %}